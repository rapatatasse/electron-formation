<div class="container">
  <div class="page-header">
    <h1 class="page-title">Gestion des Sessions</h1>
  </div>

  <div class="row" style="gap: 1.5rem;">
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Créer une nouvelle session</h3>
        </div>
        <div class="card-body">
          <%= form_with(model: [:admin, Session.new], local: true) do |f| %>
            <div class="form-group">
              <%= f.label :name, "Nom de la session *" %>
              <%= f.text_field :name, class: "form-control", placeholder: "Ex: 2024-A", required: true %>
            </div>

            <div class="form-group">
              <%= f.label :description, "Description" %>
              <%= f.text_area :description, class: "form-control", rows: 3, placeholder: "Description optionnelle" %>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; cursor: pointer;">
                <%= f.check_box :active, style: "margin-right: 0.5rem; width: auto;" %>
                <span>Session active</span>
              </label>
            </div>

            <%= f.submit "Créer la session", class: "btn btn-primary", style: "width: 100%;" %>
          <% end %>
        </div>
      </div>

      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <h3 class="card-title">Sessions existantes (<%= @sessions.count %>)</h3>
        </div>
        <div class="card-body">
          <% if @sessions.any? %>
            <div style="max-height: 400px; overflow-y: auto;">
              <% @sessions.each do |session| %>
                <div style="padding: 0.75rem; margin-bottom: 0.5rem; border: 1px solid var(--gray-200); border-radius: 4px; background: <%= session.active ? 'white' : 'var(--gray-50)' %>;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                      <strong><%= session.name %></strong>
                      <% unless session.active %>
                        <span class="badge badge-secondary" style="margin-left: 0.5rem;">Inactive</span>
                      <% end %>
                      <br>
                      <small style="color: var(--gray-600);"><%= pluralize(session.users.count, 'utilisateur') %></small>
                    </div>
                    <%= button_to "×", admin_session_path(session), method: :delete, 
                        data: { confirm: "Supprimer la session '#{session.name}' ? Cela retirera tous les utilisateurs de cette session." },
                        class: "btn btn-sm btn-danger",
                        style: "padding: 0.25rem 0.5rem; font-size: 1.2rem; line-height: 1;" %>
                  </div>
                  <% if session.description.present? %>
                    <small style="color: var(--gray-600); display: block; margin-top: 0.5rem;"><%= session.description %></small>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% else %>
            <p style="color: var(--gray-600); text-align: center; padding: 2rem;">Aucune session créée</p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Assigner des sessions aux utilisateurs</h3>
        </div>
        <div class="card-body">
          <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: var(--border-radius);">
            <%= form_with(url: admin_sessions_path, method: :get, local: true) do |f| %>
              <div style="display: flex; gap: 1rem; align-items: end; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                  <%= f.label :role, "Filtrer par rôle", style: "display: block; margin-bottom: 0.5rem; font-weight: 500;" %>
                  <%= f.select :role, 
                      options_for_select([
                        ['Tous', 'all'],
                        ['Apprenants', 'apprenant'],
                        ['Formateurs', 'formateur']
                      ], params[:role] || 'all'),
                      {}, 
                      class: "form-control",
                      onchange: "this.form.submit()" %>
                </div>
                
                <div style="flex: 1; min-width: 200px;">
                  <%= f.label :session_id, "Filtrer par session", style: "display: block; margin-bottom: 0.5rem; font-weight: 500;" %>
                  <%= f.select :session_id,
                      options_for_select([['Toutes les sessions', 'all']] + @sessions.map { |s| [s.name, s.id] }, params[:session_id] || 'all'),
                      {},
                      class: "form-control",
                      onchange: "this.form.submit()" %>
                </div>
                
                <div style="flex: 1; min-width: 200px;">
                  <%= f.label :search, "Rechercher", style: "display: block; margin-bottom: 0.5rem; font-weight: 500;" %>
                  <%= f.text_field :search, 
                      value: params[:search],
                      class: "form-control", 
                      placeholder: "Nom, prénom, email...",
                      onkeyup: "clearTimeout(window.searchTimeout); window.searchTimeout = setTimeout(() => this.form.submit(), 500)" %>
                </div>

                <div>
                  <%= f.submit "Filtrer", class: "btn btn-outline" %>
                  <%= link_to "Réinitialiser", admin_sessions_path, class: "btn btn-outline" %>
                </div>
              </div>
            <% end %>
          </div>

          <div style="margin-bottom: 1rem;">
            <strong><%= pluralize(@users.count, 'utilisateur trouvé') %></strong>
          </div>

          <% if @users.any? %>
            <div style="overflow-x: auto;">
              <table class="table" style="min-width: 800px;">
                <thead>
                  <tr>
                    <th>Utilisateur</th>
                    <th>Email</th>
                    <th>Rôle(s)</th>
                    <th>Sessions assignées</th>
                    <th style="text-align: center;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% @users.each do |user| %>
                    <tr id="user-<%= user.id %>">
                      <td><strong><%= user.full_name %></strong></td>
                      <td><%= user.email %></td>
                      <td>
                        <% user.roles.each do |role| %>
                          <span class="badge <%= role == 'apprenant' ? 'badge-info' : 'badge-success' %>">
                            <%= role.capitalize %>
                          </span>
                        <% end %>
                      </td>
                      <td>
                        <div id="user-sessions-<%= user.id %>" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                          <% user.sessions.each do |session| %>
                            <span class="badge badge-primary" style="display: flex; align-items: center; gap: 0.25rem;">
                              <%= session.name %>
                              <button type="button" 
                                      onclick="unassignSession(<%= user.id %>, <%= session.id %>)"
                                      style="background: none; border: none; color: white; cursor: pointer; padding: 0; margin-left: 0.25rem; font-size: 1.1rem; line-height: 1;"
                                      title="Retirer cette session">×</button>
                            </span>
                          <% end %>
                          <% if user.sessions.empty? %>
                            <span style="color: var(--gray-500); font-style: italic;">Aucune session</span>
                          <% end %>
                        </div>
                      </td>
                      <td style="text-align: center;">
                        <% if @sessions.any? %>
                          <select class="form-control form-control-sm" 
                                  onchange="assignSession(<%= user.id %>, this.value); this.value = '';"
                                  style="width: auto; display: inline-block; min-width: 150px;">
                            <option value="">+ Ajouter session</option>
                            <% @sessions.each do |session| %>
                              <% unless user.sessions.include?(session) %>
                                <option value="<%= session.id %>"><%= session.name %></option>
                              <% end %>
                            <% end %>
                          </select>
                        <% else %>
                          <span style="color: var(--gray-500); font-size: 0.875rem;">Créer une session d'abord</span>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p style="color: var(--gray-600); text-align: center; padding: 2rem;">
              Aucun utilisateur trouvé avec ces critères
            </p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function assignSession(userId, sessionId) {
  if (!sessionId) return;
  
  fetch(`/admin/sessions/assign`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
    },
    body: JSON.stringify({ user_id: userId, session_id: sessionId })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification(data.message, 'success');
      location.reload();
    } else {
      showNotification(data.message, 'error');
    }
  })
  .catch(error => {
    showNotification('Erreur lors de l\'assignation', 'error');
    console.error('Error:', error);
  });
}

function unassignSession(userId, sessionId) {
  if (!confirm('Retirer cette session de cet utilisateur ?')) return;
  
  fetch(`/admin/sessions/unassign`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
    },
    body: JSON.stringify({ user_id: userId, session_id: sessionId })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification(data.message, 'success');
      location.reload();
    } else {
      showNotification(data.message, 'error');
    }
  })
  .catch(error => {
    showNotification('Erreur lors du retrait', 'error');
    console.error('Error:', error);
  });
}

function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem 1.5rem;
    background: ${type === 'success' ? '#10b981' : '#ef4444'};
    color: white;
    border-radius: 4px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    z-index: 9999;
    animation: slideIn 0.3s ease-out;
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease-out';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(style);
</script>
