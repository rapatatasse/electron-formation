<div class="container">
  <div class="page-header">
    <h1 class="page-title">Gestion des utilisateurs</h1>
    <%= link_to "Nouvel utilisateur", new_admin_user_path, class: "btn btn-primary" %>
  </div>

  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Email</th>
          <th>Téléphone</th>
          <th>Rôles</th>
          <th>Sessions</th>
          <th>Inscrit le</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @users.each do |user| %>
          <tr>
            <td><%= user.full_name %></td>
            <td><%= user.email %></td>
            <td><%= user.phone %></td>
            <td>
              <% user.roles.each do |role| %>
                <span class="badge <%= role == 'admin' ? 'badge-danger' : (role == 'formateur' ? 'badge-warning' : 'badge-info') %>">
                  <%= role.capitalize %>
                </span>
              <% end %>
            </td>
            <td>
              <% if user.sessions.any? %>
                <% user.sessions.each do |session| %>
                  <span class="badge badge-secondary" style="margin: 0.1rem;"><%= session.name %></span>
                <% end %>
              <% else %>
                <span style="color: var(--gray-400);">-</span>
              <% end %>
            </td>
            <td><%= l(user.created_at, format: :short) %></td>
            <td>
              <div class="actions">
                <%= link_to "Modifier", edit_admin_user_path(user), class: "btn btn-sm btn-outline" %>
                <button onclick="openSessionModal(<%= user.id %>, '<%= user.full_name %>', <%= user.sessions.pluck(:id).to_json %>)" class="btn btn-sm btn-info">Sessions</button>
                <button onclick="openResetPasswordModal(<%= user.id %>, '<%= user.full_name %>')" class="btn btn-sm btn-secondary">Réinitialiser MDP</button>
                <% if current_user.id != user.id %>
                  <%= button_to "Supprimer", admin_user_path(user), method: :delete, :onclick => "return confirm('Êtes vous sûr ?')", class: "btn btn-sm btn-danger" %>
                <% end %>
              </div>
            </td>                                                                                                           
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <div style="margin-top: 1.5rem; text-align: center;">
      <%= paginate @users %>
    </div>
  </div>
</div>

<!-- Modal de gestion des sessions -->
<div id="sessionModal" class="modal" style="display: none;">
  <div class="modal-overlay" onclick="closeSessionModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>Gérer les sessions</h3>
      <button onclick="closeSessionModal()" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <p id="sessionUserName" style="margin-bottom: 1rem; font-weight: 600;"></p>
      <div class="form-group">
        <label class="form-label">Sessions disponibles</label>
        <div id="sessionsList" style="max-height: 300px; overflow-y: auto;">
          <% Session.active.ordered.each do |session| %>
            <label style="display: block; padding: 0.5rem; margin: 0.25rem 0; border: 1px solid var(--gray-300); border-radius: 4px; cursor: pointer;">
              <input type="checkbox" name="session_ids[]" value="<%= session.id %>" style="margin-right: 0.5rem;">
              <%= session.name %>
              <% if session.description.present? %>
                <small style="color: var(--gray-600); display: block; margin-left: 1.5rem;"><%= session.description %></small>
              <% end %>
            </label>
          <% end %>
        </div>
      </div>
      <div id="sessionError" class="alert alert-danger" style="display: none; margin-top: 1rem;"></div>
      <div id="sessionSuccess" class="alert alert-success" style="display: none; margin-top: 1rem;"></div>
    </div>
    <div class="modal-footer">
      <button onclick="closeSessionModal()" class="btn btn-outline">Annuler</button>
      <button onclick="submitSessions()" class="btn btn-primary">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Modal de réinitialisation de mot de passe -->
<div id="resetPasswordModal" class="modal" style="display: none;">
  <div class="modal-overlay" onclick="closeResetPasswordModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>Réinitialiser le mot de passe</h3>
      <button onclick="closeResetPasswordModal()" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <p id="resetPasswordUserName" style="margin-bottom: 1rem; font-weight: 600;"></p>
      <div class="form-group">
        <label for="newPassword" class="form-label">Nouveau mot de passe</label>
        <input type="text" id="newPassword" class="form-control" placeholder="Entrez le nouveau mot de passe">
        <small style="color: var(--gray-600); margin-top: 0.5rem; display: block;">Minimum 6 caractères</small>
      </div>
      <div id="resetPasswordError" class="alert alert-danger" style="display: none; margin-top: 1rem;"></div>
      <div id="resetPasswordSuccess" class="alert alert-success" style="display: none; margin-top: 1rem;"></div>
    </div>
    <div class="modal-footer">
      <button onclick="closeResetPasswordModal()" class="btn btn-outline">Annuler</button>
      <button onclick="submitResetPassword()" class="btn btn-primary">Réinitialiser</button>
    </div>
  </div>
</div>

<script>
  let currentUserId = null;
  
  function openResetPasswordModal(userId, userName) {
    currentUserId = userId;
    document.getElementById('resetPasswordUserName').textContent = 'Utilisateur : ' + userName;
    document.getElementById('newPassword').value = '';
    document.getElementById('resetPasswordError').style.display = 'none';
    document.getElementById('resetPasswordSuccess').style.display = 'none';
    document.getElementById('resetPasswordModal').style.display = 'flex';
  }
  
  function closeResetPasswordModal() {
    document.getElementById('resetPasswordModal').style.display = 'none';
    currentUserId = null;
  }
  
  function submitResetPassword() {
    const newPassword = document.getElementById('newPassword').value;
    const errorDiv = document.getElementById('resetPasswordError');
    const successDiv = document.getElementById('resetPasswordSuccess');
    
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    if (!newPassword) {
      errorDiv.textContent = 'Veuillez entrer un mot de passe';
      errorDiv.style.display = 'block';
      return;
    }
    
    fetch(`/admin/users/${currentUserId}/reset_password`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ new_password: newPassword })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        successDiv.textContent = data.message;
        successDiv.style.display = 'block';
        setTimeout(() => {
          closeResetPasswordModal();
        }, 2000);
      } else {
        errorDiv.textContent = data.error;
        errorDiv.style.display = 'block';
      }
    })
    .catch(error => {
      errorDiv.textContent = 'Une erreur est survenue';
      errorDiv.style.display = 'block';
    });
  }
  
  // Fermer la modal avec la touche Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      if (document.getElementById('resetPasswordModal').style.display === 'flex') {
        closeResetPasswordModal();
      }
      if (document.getElementById('sessionModal').style.display === 'flex') {
        closeSessionModal();
      }
    }
  });
  
  // Gestion de la modal des sessions
  let currentSessionUserId = null;
  
  function openSessionModal(userId, userName, userSessionIds) {
    currentSessionUserId = userId;
    document.getElementById('sessionUserName').textContent = 'Utilisateur : ' + userName;
    document.getElementById('sessionError').style.display = 'none';
    document.getElementById('sessionSuccess').style.display = 'none';
    
    // Cocher les sessions de l'utilisateur
    const checkboxes = document.querySelectorAll('#sessionsList input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = userSessionIds.includes(parseInt(checkbox.value));
    });
    
    document.getElementById('sessionModal').style.display = 'flex';
  }
  
  function closeSessionModal() {
    document.getElementById('sessionModal').style.display = 'none';
    currentSessionUserId = null;
  }
  
  function submitSessions() {
    const errorDiv = document.getElementById('sessionError');
    const successDiv = document.getElementById('sessionSuccess');
    
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    const checkboxes = document.querySelectorAll('#sessionsList input[type="checkbox"]:checked');
    const sessionIds = Array.from(checkboxes).map(cb => cb.value);
    
    fetch(`/admin/users/${currentSessionUserId}/update_sessions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ session_ids: sessionIds })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        successDiv.textContent = data.message;
        successDiv.style.display = 'block';
        setTimeout(() => {
          location.reload();
        }, 1000);
      } else {
        errorDiv.textContent = data.error;
        errorDiv.style.display = 'block';
      }
    })
    .catch(error => {
      errorDiv.textContent = 'Une erreur est survenue';
      errorDiv.style.display = 'block';
    });
  }
</script>
