<!--app\views\admin\quizzes\show.html.erb-->
<div class="container">
  <div class="page-header">
    <%= link_to "<", admin_quizzes_path, class: "btn btn-outline" %>
    <h1 class="page-title"><%= @quiz.title %></h1>
    
    <div>
      <%= link_to "Modifier", edit_admin_quiz_path(@quiz), class: "btn btn-outline" %>
      <%= button_to "Cr√©er une session publique", create_quiz_session_admin_quiz_path(@quiz), method: :post, class: "btn btn-secondary" %>
    </div>
  </div>

  <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
    <div class="stat-card">
      <h3><%= @quiz.question_count %>/<%= @quiz.questions.count %></h3>
      <p>Nb questions du quiz / Questions disponibles</p>
    </div>
     
    <div class="stat-card" style="background: linear-gradient(135deg, var(--secondary-color), #059669);">
      <h3><%= @quiz_sessions.count %></h3>
      <p>Sessions publiques</p>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, var(--warning-color), #d97706);">
      <h3><%= @quiz.quiz_attempts.count %></h3>
      <p>Tentatives</p>
    </div>

    <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
      <h3><%= @quiz.quiz_attempts.completed.average(:score)&.round(1) || 0 %>%</h3>
      <p>Score moyen</p>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      Informations du quiz
    </div>
    <div class="card-body">
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
        <div>
          <strong>Type :</strong>
          <% if @quiz.adaptive? %>
            <span class="badge badge-warning">Adaptatif</span>
          <% else %>
            <span class="badge badge-info">Simple</span>
          <% end %>
        </div>

        <div>
          <strong>Statut :</strong>
          <% if @quiz.active? %>
            <span class="badge badge-success">Actif</span>
          <% else %>
            <span class="badge badge-secondary">Inactif</span>
          <% end %>
        </div>

        <div>
          <strong>Dur√©e limite :</strong>
          <%= @quiz.time_limit ? "#{@quiz.time_limit} minutes" : "Aucune" %>
        </div>

        <div>
          <strong>Score minimum :</strong>
          <%= @quiz.passing_score || "Non d√©fini" %>%
        </div>



        <div>
          <strong>Ordre al√©atoire :</strong>
          <%= @quiz.randomize_questions? ? "Oui" : "Non" %>
        </div>
      </div>

      <% if @quiz.description.present? %>
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
          <strong>Description :</strong>
          <p style="margin-top: 0.5rem;"><%= @quiz.description %></p>
        </div>
      <% end %>
      <!--question par theme-->
      <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
        <strong>Questions par th√®me :</strong>
        <% questions_count_by_theme_id = @quiz.questions.group(:theme_id).count %>
        <% themes_by_id = Theme.where(id: questions_count_by_theme_id.keys).index_by(&:id) %>
        <% questions_count_by_theme_id.each do |theme_id, count| %>
          <p style="margin-top: 0.5rem;"><%= themes_by_id[theme_id]&.name || "(th√®me supprim√©)" %> : <%= count %></p>
        <% end %>
      </div>
    </div>
  </div>

  <% if @quiz_sessions.any? %>
    <div class="card">
      <div class="card-header">
        Sessions publiques (<%= @quiz_sessions.count %>)
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Cr√©√©e le</th>
            <th>Statut</th>
            <th>Lien</th>
            <th>QR</th>
          </tr>
        </thead>
        <tbody>
          <% @quiz_sessions.each do |qs| %>
            <tr>
              <td><%= l(qs.created_at, format: :short) %></td>
              <td>
                <% if qs.active? %>
                  <span class="badge badge-success">Active</span>
                <% else %>
                  <span class="badge badge-secondary">Inactive</span>
                <% end %>
              </td>
              <td>
                <%= link_to qs.public_url, qs.public_url, class: "btn btn-sm btn-outline" %>
              </td>
              <td>
                <% qr = RQRCode::QRCode.new(qs.public_url) %>
                <div style="width: 110px;">
                  <%= qr.as_svg(module_size: 4).html_safe %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>

 
 
 <!---------------gestion des questions---------------------->
    <div style="display: flex; gap: 0.5rem;">
      <%= link_to "Ajouter une question", new_admin_quiz_question_path(@quiz), class: "btn btn-primary" %>
      <%= link_to "üì• Importer CSV", import_admin_quiz_questions_path(@quiz), class: "btn btn-secondary" %>
      <% if @quiz.questions.any? %>
        <%= link_to "üì§ Exporter CSV", export_admin_quiz_questions_path(@quiz), class: "btn btn-outline" %>
    
        <%= button_to  "üóëÔ∏è Supprimer toutes les questions", destroy_all_admin_quiz_questions_path(@quiz), method: :delete, :onclick => "return confirm('√ätes vous s√ªr ?')", class: "btn btn-danger" %>
 
      <% end %>
    </div>
      <div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-body">
      <strong>Quiz :</strong> <%= @quiz.title %> 
      <span class="badge badge-info" style="margin-left: 1rem;"><%= @quiz.questions.count %> questions</span>
    </div>
  </div>
  <% if @questions.any? %>
    <% @questions.order(:position).each_with_index do |question, index| %>
      <div class="card" style="margin-bottom: 1rem;">
        <div class="card-body">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <h4 style="margin-bottom: 0.5rem;">Question <%= index + 1 %> : <span style="font-size: 1.1rem; color: var(--primary-dark)"><%= question.question_text %></span></h4>            
              <div style="display: flex; gap: 1rem; margin: 1rem 0;">
                <span class="badge badge-info">Niveau <%= question.difficulty_level %></span>
                <span class="badge" style="background-color: <%= question.theme.color %>; color: white;"><%= question.theme.name %></span>
                <% if question.multiple_correct_answers? %>
                  <span class="badge badge-warning">R√©ponses multiples</span>
                <% end %>
              </div>

              <% if question.image_url.present? %>
                <div style="margin: 1rem 0;">
                  <img src="<%= question.image_url %>" alt="Image question" style="max-width: 300px; border-radius: var(--border-radius);">
                </div>
              <% end %>

              <div style="margin-top: 1rem;">
                <strong>R√©ponses :</strong>
                <ul style="margin-top: 0.5rem; list-style: none; padding-left: 0;">
                  <% question.answers.each do |answer| %>
                    <li style="padding: 0.5rem; margin: 0.25rem 0; background: <%= answer.correct? ? '#d1fae5' : '#f3f4f6' %>; border-radius: 4px;">
                      <%= answer.correct? ? '‚úì' : '‚úó' %>
                      <%= answer.answer_text %>
                    </li>
                  <% end %>
                </ul>
              </div>
            </div>

            <div style="margin-left: 1rem;">
              <%= link_to "Modifier", edit_admin_quiz_question_path(@quiz, question), class: "btn btn-sm btn-outline" %>
              <%= button_to "Supprimer", admin_quiz_question_path(@quiz, question), method: :delete, :onclick => "return confirm('√ätes vous s√ªr ?')", class: "btn btn-sm btn-danger" %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="card">
      <div class="card-body" style="text-align: center; padding: 3rem;">
        <p style="color: var(--gray-600); margin-bottom: 1rem;">Aucune question pour ce quiz</p>
        <%= link_to "Cr√©er la premi√®re question", new_admin_quiz_question_path(@quiz), class: "btn btn-primary" %>
      </div>
    </div>
  <% end %>
</div>
